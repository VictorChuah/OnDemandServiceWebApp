@using fyptest.Models
@model OverallAccVM

@{ ViewBag.Title = "ProviderProfile";
  Layout = "~/Views/Shared/_Layout.cshtml"; }

@section head{
  <style>
    #upload img {
      width: 200px;
      height: 200px;
      cursor: pointer;
    }
  </style>
}

<div style="height: 113px;"></div>

<div class="unit-5 overlay" style="background-image: url('../../Image/Background/hero_2.jpg');">
  <div class="container text-center">
    <h2 class="mb-0">Profile</h2>
    <p class="mb-0 unit-6"><a href="index.html">Home</a> <span class="sep">></span> <span>Profile</span></p>
  </div>
</div>

<!-- Page Content -->

<div class="site-section bg-light">
  <div class="container">
    @*top*@
    <div class="row">
      @*left panel*@
      <div class="col-md-12 col-lg-8 mb-5">
        <div class="p-5 bg-white">
          <div class="row form-group">
            <div class="col-md-12 mb-3 mb-md-0">
              <label class="font-weight-bold" for="email">Email</label>
              <p class="mb-4" id="email">@Model.Account.email</p>
            </div>
          </div>

          <div class="row form-group">
            <div class="col-md-12 mb-3 mb-md-0">
              <label class="font-weight-bold" for="phone">Phone</label>
              <p class="mb-4" id="phone">@Model.Account.phone</p>
              <input type="text" id="editPhone" class="form-control" placeholder="60123456789" value=@Model.Account.phone required>
              <p><span id="error">Invalid Format (60123456789)</span> </p>
            </div>
          </div>

          <div class="row form-group">
            <div class="col-md-12 mb-3 mb-md-0">
              <label class="font-weight-bold" for="Address">Address</label>
              <p class="mb-4" id="address">@Model.Account.address</p>
              <input type="text" id="editAddress" class="form-control" placeholder="Address" value="@Model.Account.address" required>
            </div>
          </div>

          @if (@Model.Account.companyIndividual)
          {
            <div class="row form-group">
              <div class="col-md-12">
                <label class="font-weight-bold" for="name">Name</label>
                <p class="mb-4">@Model.Account.name</p>
              </div>
            </div> }
          else if (!@Model.Account.companyIndividual)
          {
            <div class="row form-group">
              <div class="col-md-12">
                <label class="font-weight-bold" for="companyName">Company Name</label>
                <p class="mb-4">@Model.Account.companyName</p>
              </div>
            </div>}

          <div class="row form-group">
            <div class="col-md-12">
              <label class="font-weight-bold" for="serviceType">Services</label>
              <p class="mb-4">@Model.Account.Service_Type.name</p>
            </div>
          </div>

          <div class="row form-group">
            <div class="col-md-3">
              <label class="font-weight-bold" for="attitude">Attitude</label>
              @switch (Model.Rate.attitude)
              {
                case 1:<p class="mb-4"> &#9733;&#9734;&#9734;&#9734;&#9734; </p> ; break;
                case 2: <p class="mb-4"> &#9733;&#9733;&#9734;&#9734;&#9734;</p> ; break;
                case 3: <p class="mb-4"> &#9733;&#9733;&#9733;&#9734;&#9734; </p> ; break;
                case 4: <p class="mb-4"> &#9733;&#9733;&#9733;&#9733;&#9734; </p> ; break;
                case 5: <p class="mb-4"> &#9733;&#9733;&#9733;&#9733;&#9733; </p> ; break;
                default: <p class="mb-4"> &#9734;&#9734;&#9734;&#9734;&#9734; </p>; break;
              }
            </div>
            <div class="col-md-3">
              <label class="font-weight-bold" for="quality">Quality</label>
              @switch (Model.Rate.quality)
              {
                case 1:<p class="mb-4"> &#9733;&#9734;&#9734;&#9734;&#9734; </p> ; break;
                case 2: <p class="mb-4"> &#9733;&#9733;&#9734;&#9734;&#9734;</p> ; break;
                case 3: <p class="mb-4"> &#9733;&#9733;&#9733;&#9734;&#9734; </p> ; break;
                case 4: <p class="mb-4"> &#9733;&#9733;&#9733;&#9733;&#9734; </p> ; break;
                case 5: <p class="mb-4"> &#9733;&#9733;&#9733;&#9733;&#9733; </p> ; break;
                default: <p class="mb-4"> &#9734;&#9734;&#9734;&#9734;&#9734; </p>; break;
              }
            </div>
            <div class="col-md-3">
              <label class="font-weight-bold" for="efficiency">Efficiency</label>
              @switch (Model.Rate.efficiency)
              {
                case 1:<p class="mb-4"> &#9733;&#9734;&#9734;&#9734;&#9734; </p> ; break;
                case 2: <p class="mb-4"> &#9733;&#9733;&#9734;&#9734;&#9734;</p> ; break;
                case 3: <p class="mb-4"> &#9733;&#9733;&#9733;&#9734;&#9734; </p> ; break;
                case 4: <p class="mb-4"> &#9733;&#9733;&#9733;&#9733;&#9734; </p> ; break;
                case 5: <p class="mb-4"> &#9733;&#9733;&#9733;&#9733;&#9733; </p> ; break;
                default: <p class="mb-4"> &#9734;&#9734;&#9734;&#9734;&#9734; </p>; break;
              }
            </div>
            <div class="col-md-3">
              <label class="font-weight-bold" for="professionalism">Professionalism</label>
              @switch (Model.Rate.professionalism)
              {
                case 1:<p class="mb-4"> &#9733;&#9734;&#9734;&#9734;&#9734; </p> ; break;
                case 2: <p class="mb-4"> &#9733;&#9733;&#9734;&#9734;&#9734;</p> ; break;
                case 3: <p class="mb-4"> &#9733;&#9733;&#9733;&#9734;&#9734; </p> ; break;
                case 4: <p class="mb-4"> &#9733;&#9733;&#9733;&#9733;&#9734; </p> ; break;
                case 5: <p class="mb-4"> &#9733;&#9733;&#9733;&#9733;&#9733; </p> ; break;
                default: <p class="mb-4"> &#9734;&#9734;&#9734;&#9734;&#9734; </p>; break;
              }
            </div>
          </div>

          @if (Model.Role == "Provider")
          {
            <div class="row form-group">
              <div class="col-md-12">
                <input type="button" value="Edit" class="btn btn-primary pill px-4 py-2" id="edit">
                <input type="button" value="Confirm" class="btn btn-primary pill px-4 py-2" id="confirm">
                <input type="button" value="Cancel" class="btn btn-primary pill px-4 py-2" id="cancel">
              </div>
            </div>
          }



        </div>
      </div>

      @*right panel*@
      <div class="col-lg-4">
        <div class="p-4 mb-3 bg-white">
          <h3 class="h5 text-black mb-3">Profile Image</h3>
          @if (Model.Role == "Provider")
          {
            <form enctype="multipart/form-data" name="file" id="profile_pic_form">
              <label class="text-info p-2 rounded border border-info" id="upload">
                <input type="file" id="file" name="file" accept="image/jpeg,image/png,image/jpg" hidden="" />
                @*@Html.TextBoxFor(m => m.ProfileImage, new { type = "file", accept = "image/jpeg,image/png,image/jpg", hidden = "" })*@
                <img src="~/Image/Profile/@Model.Account.profileImage" />
                <br />
                <small id="image">Select photo...</small>
              </label>
            </form> }
          else
          {
            <img src="~/Image/Profile/@Model.Account.profileImage" />
          }
        </div>

        @if (Model.Role == "Provider")
        {
          <div class="p-4 mb-3 bg-white">
            <h3 class="h5 text-black mb-3">Wallet</h3>
            <div class="popup" onclick="popupInfo()">
              <small>All transaction will be made on wallet, including <b>charges</b> by platform.</small>
              <span class="popuptext" id="myPopup">5% of the request price will be charged as fee.</span>
            </div>
            <br />
            <br />
            <p>RM <b>@Model.Account.walletAmount</b></p>
            <p>
              <button class="btn btn-primary px-4 py-2 text-white pill" id="topup">Top Up</button>
              <a href="~/JobProvider/Withdraw"><button class="btn btn-primary px-4 py-2 text-white pill">Withdrawn</button></a>
            </p>
            <p id="topupMethod">
              <a href="~/JobProvider/Topup" class="btn btn-primary px-2 py-1 text-white pill"><small>Debit Card</small></a>
              <a href="~/JobProvider/TopupPaypal" class="btn btn-primary px-2 py-1 text-white pill"><small>PayPal Quick Topup (RM20)</small></a>
            </p>

          </div>}

        <div class="p-4 mb-3 bg-white">
          <h3 class="h5 text-black mb-3">Namecard</h3>
          <label class="text-info p-2 rounded border border-info">
            <img src="~/Image/NameCard/@(Model.Account.namecard == null? "add.png" : Model.Account.namecard )" style="width:300px; height:200px" />
          </label>

          @if (Model.Role == "Provider")
          {
            <a href="~/JobProvider/EditNameCard"><label class="btn btn-primary px-4 py-2 text-white pill">Edit</label></a>
            if (Model.Account.namecard != null)
            {
              if (!Model.Account.postNamecard)
              {
                <label id="postNamecard" class="btn btn-primary px-4 py-2 text-white pill">Post</label>
                <div id="dialog-confirm" title="Post Namecard?">
                  <b>M5.00</b> will deduct upon confirmation and subsequent month. If you wallet does not have suffient fund, it will auto unpost your namecard. <b>Confirm Post?</b>
                </div>
              }
              else
              {
                <label id="postNamecard" class="btn btn-primary px-4 py-2 text-white pill">Unpost</label>
                <p id="notice"></p>
                <div id="dialog-confirm" title="Unpost Namecard?">
                  Money that has been deduct will <b>not</b> be refund. <b>Confirm unpost?</b>
                </div>
              }
              <p class="text-danger">@ViewBag.unpost</p>
            }
          }

        </div>
      </div>
    </div>

    @if (Model.Role == "Provider")
    {
      @*middle ongoing*@
      <div class="row">
        <div class="col-md-8 mb-5 mb-md-0" data-aos="fade-up" data-aos-delay="100">
          <h2 class="mb-5 h3"><a class="mb-5 h3" href="~/Service/RequestList?status=1">Recent Jobs</a></h2>
          <div class="rounded border jobs-wrap">
            @foreach (var r in Model.RequestDetail.Take(5))
            {
              if (r.status == 1)
              {
                <a href="~/Service/RequestList?status=1&selected=@r.title" class="job-item d-block d-md-flex align-items-center  border-bottom fulltime">
                  <div class="company-logo blank-logo text-center text-md-left pl-3">
                    <img src="~/Content/main/images/company_logo_blank.png" alt="Image" class="img-fluid mx-auto">
                  </div>
                  <div class="job-details h-100">
                    <div class="p-3 align-self-center">
                      <h3>@r.title</h3>
                      <div class="d-block d-lg-flex">
                        <div class="mr-3">
                          <span class="icon-suitcase mr-1"></span>
                          @(r.Service_Category.SCId == r.Category ? r.Service_Category.name : "-" )
                        </div>
                        <div class="mr-3"><span class="icon-room mr-1"></span> @(r.address == null ? "-" : r.address)</div>
                        <div><span class="icon-money mr-1"></span> RM @r.price </div>
                      </div>
                    </div>
                  </div>
                  <div class="job-category align-self-center">
                    <div class="p-3">
                      @if (r.seekerComplete == false && r.providerComplete == true)
                      {
                        <span class="text-info p-2 rounded border border-info btn">Pending</span> ;
                      }
                      else if (r.providerComplete == false)
                      {
                        <span class="text-danger p-2 rounded border border-danger btn" onclick="completeJob('@r.SId')">Ongoing</span>;
                      }
                      else
                      {
                        <span class="text-warning p-2 rounded border border-warning btn">Ongoing</span>;
                      }
                    </div>
                  </div>
                </a>}
            }
          </div>

          <br />
          @*bottom complete*@
          <h2 class="mb-5 h3"><a class="mb-5 h3" href="~/Service/RequestList?status=2">History</a></h2>
          <div class="rounded border jobs-wrap">
            @foreach (var r in Model.RequestDetail.Take(5))
            {
              if (r.status == 2)
              {
                <a href="~/Service/RequestList?status=2&selected=@r.title" class="job-item d-block d-md-flex align-items-center  border-bottom fulltime">
                  <div class="company-logo blank-logo text-center text-md-left pl-3">
                    <img src="~/Content/main/images/company_logo_blank.png" alt="Image" class="img-fluid mx-auto">
                  </div>
                  <div class="job-details h-100">
                    <div class="p-3 align-self-center">
                      <h3>@r.title</h3>
                      <div class="d-block d-lg-flex">
                        <div class="mr-3">
                          <span class="icon-suitcase mr-1"></span>
                          @(r.Service_Category.SCId == r.Category ? r.Service_Category.name : "-" )
                        </div>
                        <div class="mr-3"><span class="icon-room mr-1"></span> @(r.address == null ? "-" : r.address)</div>
                        <div><span class="icon-money mr-1"></span> RM @r.price </div>
                      </div>
                    </div>
                  </div>
                  <div class="job-category align-self-center">
                    <div class="p-3">
                      <span class="text-success p-2 rounded border border-success">Completed</span>
                    </div>
                  </div>
                </a>}
            }
          </div>
        </div>

        @*btm right recommend*@
        <div class="col-md-4 block-16" data-aos="fade-up" data-aos-delay="200">
          <div class="d-flex mb-0">
            <h2 class="mb-5 h3 mb-0"><a class="mb-5 h3" href="~/Service/RequestList?status=0">Featured Jobs</a></h2>
            <div class="ml-auto mt-1"><a href="#" class="owl-custom-prev">Prev</a> / <a href="#" class="owl-custom-next">Next</a></div>
          </div>
          <div class="nonloop-block-16 owl-carousel">
            @foreach (var r in Model.Recommend.Take(4))
            {
              <div class="border rounded p-4 bg-white">
                <h2 class="h5">@r.title</h2>
                <p style="cursor:pointer"><a href="~/Service/RequestList?status=0&selected=@r.title"><span class="text-info p-2 rounded border border-info">Recommend</span></a></p>
                <p>
                  <span class="d-block"><span class="icon-suitcase"></span> @(r.Service_Category.SCId == r.Category ? r.Service_Category.name : "-" )</span>
                  <span class="d-block"><span class="icon-room"></span> @(r.address == null ? "-" : r.address)</span>
                  <span class="d-block"><span class="icon-money mr-1"></span> RM @r.price </span>
                </p>
                <p class="mb-0">@r.description</p>
              </div>}
          </div>

          <div id="app" v-show="found">
            @*<div class="d-flex mb-0">
                <h2 class="mb-5 h3 mb-0"><a class="mb-5 h3" href="~/Service/RequestList?status=0">Urgent</a></h2>
                <div class="ml-auto mt-1"><a href="#" class="owl-custom-prev">Prev</a> / <a href="#" class="owl-custom-next">Next</a></div>
              </div>*@
            <div class="nonloop-block-16 owl-carousel" id="immediate">
            </div>
            <input id="type" value="@Model.Account.Service_Type.name" hidden />
          </div>
        </div>
      </div>
    }
  </div>
</div>



@section foot {
  @Scripts.Render("~/bundles/jqueryval")
  <script src="//code.jquery.com/jquery-1.12.4.js"></script>
  <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.21.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.17.1/firebase-firestore.js"></script>
  <script src="~/Scripts/vue.js"></script>
  <script src="~/Scripts/vuefire.js"></script>
  @*<script src="~/Scripts/service-worker.js"></script>
  <script src="~/Scripts/service-worker-notification.js"></script>
  <script src="~/Scripts/service-worker-push.js"></script>

  <link href="~/manifestPushNotification.json" />*@

  <script>

    var check = true;

    var $regexname = /^(601)([0-9]{8})$/;
    $('#editPhone').on('keypress keydown keyup', function () {
      console.log("check")
      if (!$('#editPhone').val().match($regexname)) {
        // there is a mismatch, hence show the error message
        $('#error').show();
        check = false;
      }
      else {
        // else, do not display message
        $('#error').hide();
        check = true;
      }
    });

    //jQuery(function ($) {
    //  $("#editPhone").mask("99999999999");
    //});

    $(document).ready(() => {
      $('#error').hide();
      $('#editPhone').hide();
      $('#editAddress').hide();
      $('#confirm').hide();
      $('#cancel').hide();
      $('#topupMethod').hide();
      $("#dialog-confirm").hide();
      console.log("f3wefqaf")
    });


    $('#edit').click(() => {
      $('#phone').hide(500);
      $('#address').hide(500);
      $('#edit').hide(500);

      $('#editPhone').show(500);
      $('#editAddress').show(500);
      //$('#image').show();
      $('#cancel').show(500);
      $('#confirm').show(500);
    });

    $('#cancel').click(() => {
      $('#phone').show(500);
      $('#address').show(500);
      $('#edit').show(500);

      $('#editPhone').hide(500);
      $('#editAddress').hide(500);
      //$('#image').hide();
      $('#cancel').hide(500);
      $('#confirm').hide(500);
    });

    $('#topup').click(() => {
      $('#topupMethod').show(500);
    })

    function validatePhoto(f) {
      let reType = /^image\/(jpeg|png)$/i;
      let reName = /^.+\.(jpg|jpeg|png)$/i;

      return f &&
        f.size <= 1 * 1024 * 1024 &&
        reType.test(f.type) &&
        reName.test(f.name);
    }

    let src = null;

    $('#upload input').change(e => {
      let f = e.target.files[0];
      let img = $(e.target).siblings('img')[0];

      if (!src) src = img.src;

      if (validatePhoto(f)) {
        img.src = URL.createObjectURL(f);
      }
      else {
        img.src = src;
        e.target.value = '';
      }
      //$(e.target).valid();

      update()
    });

    //detail edit
    $('#confirm').click(() => {
      if (check) {
        $.ajax({
          url: '/JobProvider/EditProfile',
          data: JSON.stringify({
            model: {
              Email: $('#email').text(),
              Phone: $('#editPhone').val(),
              Address: $('#editAddress').val(),
              //ProfileImage: file
            }
          }),
          type: 'POST',
          contentType: 'application/json; charset=utf-8',
          success: data => {
            $('#phone').text(data.Phone);
            $('#address').text(data.Address);
          },
          error: () => {
            $('#phone').text("error");
          }
        });
        $('#cancel').trigger("click");
      }
      else {
        $('#error').effect('shake');
      }
    });

    //post or unpost namecard
    $('#postNamecard').click(() => {
      $("#dialog-confirm").dialog({
        resizable: false,
        height: 220,
        width: 475,
        modal: true,
        buttons: [{
          text: "OK",
          click: function () {
            let p = $('#postNamecard').text() == 'Post' ? true : false;

            $.ajax({
              url: '/jobprovider/PostNamecard',
              data: { posting: p },
              type: 'POST',
              contenttype: 'application/json; charset=utf-8',
              success: data => {
                alert(data);
              },
              error: () => {
                alert("error!")
              }
            });

            $("#dialog-confirm").dialog("close");
          }
        }, {
          text: "Cancel",
          click: function () {
            $("#dialog-confirm").dialog("close");
          }
        }]
      });
    });



    //change profilepic
    function update() {
      console.log("1234")
      $.ajax({
        url: '/JobProvider/EditProfilePic',
        type: 'POST',
        data: new FormData($('#profile_pic_form')[0]),
        cache: false,
        processData: false,
        contentType: false,
        xhr: function () {  // Custom XMLHttpRequest
          var myXhr = $.ajaxSettings.xhr();
          return myXhr
        },
        success: function () {
          $('#image').text("Uploaded");
        },
        error: function () {
          $('#image').text("Upload Failed");
        }
      });
    }

    function completeJob(sid) {
      $.ajax({
        url: '/Service/ProviderCompleteJob',
        data: JSON.stringify({
          model: {
            Provider: $('#email').text(),
            JobID: sid
          }
        }),
        type: 'POST',
        contentType: 'application/json; charset=utf-8',
        success: data => {
          alert("You have completed this service.");
        },
        error: function (response) {
          alert("Something went wrong. Please try again.");
        }
      });
    }

    function popupInfo() {
      var popup = document.getElementById("myPopup");
      popup.classList.toggle('show');
    }


    //firestore
    firebase.initializeApp({
      projectId: "rit3mwxccx-fyp",
      storageBucket: 'gs://rit3mwxccx-fyp.appspot.com'
    });

    const db = firebase.firestore().collection('notify');
    Vue.use(Vuefire.firestorePlugin);

    const app = new Vue({
      el: '#app',
      data: {
        id: '',
        title: '',
        type: '?',
        found: false
      },
      created() {

      },
      async mounted() {
        //get type from html
        this.type = $('#type').val();

        db.doc(this.type).onSnapshot(snap => {
          //snap.docChanges().forEach(change => {
          //  const { type, doc } = change;
          let data = snap.data();

          if (data.requestId != "") {
            this.id = data.requestId;
            this.title = data.title;
            this.found = true;
            this.onChange();
          }
          
        })
      },
      methods: {
        //detect db changee
        onChange() {

          $('#immediate').append(`
          <div class="border rounded p-4 bg-white">
            <h2 class="h5">${this.title}</h2>
            <p style="cursor:pointer"><a href="/Service/JobView/${this.id}"><span class="text-danger p-2 rounded border border-danger btn">Immediate</span></a></p>
          </div>`);

          alert("New immediate request!")
        }
      }
    });

  </script>
}
