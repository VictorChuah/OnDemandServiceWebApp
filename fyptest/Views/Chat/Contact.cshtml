@model fyptest.Models.ConversationModel
@{
  ViewBag.Title = "Contact";
}
<head>
  <script src="~/Scripts/bootstrap.min.js"></script>

</head>
<div class="page-content page-container" id="page-content">
  <div class="padding">
    <div class="row container d-flex justify-content-center" style="margin: 0 auto 0 auto;" id="@Model.ConnectionModelObj.GroupName.Replace('#','_')">
      <div class="col-md-12">
        <div class="card card-bordered">
          <div class="card-header">
            <h4 class="card-title fw-bold fs-3" style="margin:0 auto 0 auto;"><strong>@Model.ConnectionModelObj.Receiver</strong></h4> @*<a class="btn btn-xs btn-secondary" href="#" data-abc="true">
                  Chat
              </a>*@
          </div>
          <div class="ps-container ps-theme-default ps-active-y bg-gradient" id="chat-content" style="overflow-y: scroll !important; background-color:burlywood;">
            @foreach (var message in Model.MessageList)
            {
              if (message.MessageId == "Date Sep")
              {
                <div class="strike">
                  <span>@message.MsgDate</span>
                </div>
              }
              else if (message.Sender == Session["Email"].ToString())
              {
                <div class="media media-chat media-chat-reverse">
                  <div class="media-body context-menu-one">
                    <p id="@message.MessageId">@Html.Raw(message.Message)</p>
                    <p class="meta"><time datetime="2018">@message.StartTime</time></p>
                  </div>
                </div>
              }
              else
              {
                <div class="media media-chat">
                  <div class="media-body">
                    <p>@Html.Raw(message.Message)</p>
                    <p class="meta"><time datetime="2018">@message.StartTime</time></p>
                  </div>
                </div>
              }
            }
            <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px;">
              <div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div>
            </div>
            <div class="ps-scrollbar-y-rail" style="top: 0px; height: 0px; right: 2px;">
              <div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 2px;"></div>
            </div>

          </div>
          <div class="publisher bt-1 border-light">
            @if (Session["Email"].ToString() == Model.ConnectionModelObj.Seeker)
            {
              <img class="avatar avatar-xs" src="@Url.Content(Model.ConnectionModelObj.SeekerPhoto)" width="150" alt="...">
            }
            else
            {
              <img class="avatar avatar-xs" src="@Url.Content(Model.ConnectionModelObj.ProviderPhoto)" width="150" alt="...">
            }

            <input id="chat_input" class="publisher-input" type="text" placeholder="Write something">
            <span class="publisher-btn file-group" id="uploadFile">
              <i class="fa fa-paperclip file-browser"></i>
            </span>
            <a class="publisher-btn text-info" href="#" data-abc="true" id="btn_submit"><i class="fa fa-paper-plane"></i></a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="dialog" class="btn btn-sm btn-danger"><i class="fa fa-trash"></i> Delete</div>
<div id="modal" class="modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Choose Image/File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form enctype="multipart/form-data" role="form" class="form-horizontal" id="form">
          <input class="form-control-lg form-control-lg shadow-sm" type="file" name="file" />
        </form>
        <input class="btn btn-info btn-lg" type="submit" id="btn_upload" value="Upload Image/File" />
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Done</button>
        </div>
      </div>
    </div>
  </div>
</div>


<!--Script references. -->
<!--Reference the jQuery library. -->
<!--Reference the SignalR library. -->
<script src="~/Scripts/jquery.signalR-2.4.2.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/SignalR/Hubs/"></script>
<!--Add script to update the page and send messages.-->
<style type="text/css">
  .strike {
    display: block;
    text-align: center;
    overflow: hidden;
    white-space: nowrap;
  }

    .strike > span {
      position: relative;
      display: inline-block;
    }

      .strike > span:before,
      .strike > span:after {
        content: "";
        position: absolute;
        top: 50%;
        width: 9999px;
        height: 1px;
        background: gray;
      }

      .strike > span:before {
        right: 100%;
        margin-right: 15px;
      }

      .strike > span:after {
        left: 100%;
        margin-left: 15px;
      }

  #dialog {
    position: absolute;
    z-index: 20;
    display: none;
  }


  .card-bordered {
    border: 1px solid #ebebeb
  }

  .card {
    border: 0;
    border-radius: 0px;
    margin-bottom: 30px;
    -webkit-box-shadow: 0 2px 3px rgba(0, 0, 0, 0.03);
    box-shadow: 0 2px 3px rgba(0, 0, 0, 0.03);
    -webkit-transition: .5s;
    transition: .5s
  }

  .padding {
    padding: 3rem !important
  }

  body {
    background-color: #f9f9fa
  }

  .card-header:first-child {
    border-radius: calc(.25rem - 1px) calc(.25rem - 1px) 0 0
  }

  .card-header {
    display: -webkit-box;
    display: flex;
    -webkit-box-pack: justify;
    justify-content: space-between;
    -webkit-box-align: center;
    align-items: center;
    padding: 15px 20px;
    background-color: transparent;
    border-bottom: 1px solid rgba(77, 82, 89, 0.07)
  }

    .card-header .card-title {
      padding: 0;
      border: none
    }

  h4.card-title {
    font-size: 17px
  }

  .card-header > *:last-child {
    margin-right: 0
  }

  .card-header > * {
    margin-left: 8px;
    margin-right: 8px
  }

  .btn-secondary {
    color: #4d5259 !important;
    background-color: #e4e7ea;
    border-color: #e4e7ea;
    color: #fff
  }

  .btn-xs {
    font-size: 11px;
    padding: 2px 8px;
    line-height: 18px
  }

    .btn-xs:hover {
      color: #fff !important
    }

  .card-title {
    font-family: Roboto, sans-serif;
    font-weight: 300;
    line-height: 1.5;
    margin-bottom: 0;
    padding: 15px 20px;
    border-bottom: 1px solid rgba(77, 82, 89, 0.07)
  }

  .ps-container {
    position: relative
  }

  .ps-container {
    -ms-touch-action: auto;
    touch-action: auto;
    overflow: hidden !important;
    -ms-overflow-style: none
  }

  .media-chat {
    padding-right: 64px;
    margin-bottom: 0
  }

  .media {
    padding: 16px 12px;
    -webkit-transition: background-color .2s linear;
    transition: background-color .2s linear
  }

    .media .avatar {
      flex-shrink: 0
    }

  .avatar {
    position: relative;
    display: inline-block;
    width: 36px;
    height: 36px;
    line-height: 36px;
    text-align: center;
    border-radius: 100%;
    background-color: #f5f6f7;
    color: #8b95a5;
    text-transform: uppercase
  }

  .media-chat .media-body {
    -webkit-box-flex: initial;
    flex: initial;
    display: table
  }

  .media-body {
    min-width: 0
  }

  .media-chat .media-body p {
    position: relative;
    padding: 6px 8px;
    margin: 4px 0;
    background-color: #f5f6f7;
    border-radius: 3px;
    font-weight: 100;
    color: #9b9b9b
  }

  .media > * {
    margin: 0 8px
  }

  .media-chat .media-body p.meta {
    background-color: transparent !important;
    padding: 0;
    opacity: .8
  }

  .media-meta-day {
    -webkit-box-pack: justify;
    justify-content: space-between;
    -webkit-box-align: center;
    align-items: center;
    margin-bottom: 0;
    color: #8b95a5;
    opacity: .8;
    font-weight: 400
  }

  .media {
    padding: 16px 12px;
    -webkit-transition: background-color .2s linear;
    transition: background-color .2s linear
  }

  .media-meta-day::before {
    margin-right: 16px
  }

  .media-meta-day::before,
  .media-meta-day::after {
    content: '';
    -webkit-box-flex: 1;
    flex: 1 1;
    border-top: 1px solid #ebebeb
  }

  .media-meta-day::after {
    content: '';
    -webkit-box-flex: 1;
    flex: 1 1;
    border-top: 1px solid #ebebeb
  }

  .media-meta-day::after {
    margin-left: 16px
  }

  .media-chat.media-chat-reverse {
    padding-right: 12px;
    padding-left: 64px;
    -webkit-box-orient: horizontal;
    -webkit-box-direction: reverse;
    flex-direction: row-reverse;
  }

  .media-chat-reverse > .media-body {
    margin-left: auto;
  }

  .media-chat {
    padding-right: 64px;
    margin-bottom: 0
  }

  .media {
    padding: 16px 12px;
    -webkit-transition: background-color .2s linear;
    transition: background-color .2s linear
  }

  .media-chat.media-chat-reverse .media-body p {
    float: right;
    clear: right;
    background-color: #48b0f7;
    color: #fff;
    word-break: break-word;
  }

  .media-chat .media-body p {
    position: relative;
    padding: 6px 8px;
    margin: 4px 0;
    background-color: #f5f6f7;
    border-radius: 3px;
    word-break: break-word;
  }


  .border-light {
    border-color: #f1f2f3 !important
  }

  .bt-1 {
    border-top: 1px solid #ebebeb !important
  }

  .publisher {
    position: relative;
    display: -webkit-box;
    display: flex;
    -webkit-box-align: center;
    align-items: center;
    padding: 12px 20px;
    background-color: #f9fafb
  }

    .publisher > *:first-child {
      margin-left: 0
    }

    .publisher > * {
      margin: 0 8px
    }

  .publisher-input {
    -webkit-box-flex: 1;
    flex-grow: 1;
    border: none;
    outline: none !important;
    background-color: transparent
  }

  button,
  input,
  optgroup,
  select,
  textarea {
    font-family: Roboto, sans-serif;
    font-weight: 300
  }

  .publisher-btn {
    background-color: transparent;
    border: none;
    color: #8b95a5;
    font-size: 16px;
    cursor: pointer;
    overflow: -moz-hidden-unscrollable;
    -webkit-transition: .2s linear;
    transition: .2s linear
  }

  .file-group {
    position: relative;
    overflow: hidden
  }

  .publisher-btn {
    background-color: transparent;
    border: none;
    color: #cac7c7;
    font-size: 16px;
    cursor: pointer;
    overflow: -moz-hidden-unscrollable;
    -webkit-transition: .2s linear;
    transition: .2s linear
  }

  .file-group input[type="file"] {
    position: absolute;
    opacity: 0;
    z-index: -1;
    width: 100%
  }

  .text-info {
    color: #48b0f7 !important
  }
</style>
@section foot {
  @Scripts.Render("~/bundles/jqueryval")
  <script type="text/javascript">
        $(document).ready(function () {
            $("#chat-content").parent().height($(window).height());
            var height = $('#chat-content')[0].scrollHeight;
            $('#chat-content').scrollTop(height);

        });

        $("#uploadFile").on('click', function () {
            $("#modal").modal("show");
        });

        var objHub = $.connection.chatHub;
        $.connection.hub.start().done(function () {
              //loadEvents(objHub);
          console.log("Suubmit "+"@Session["Email"].ToString()");
              objHub.server.connect("@Session["Email"].ToString()","@Session["Role"].ToString()");
              $('#chat_input').focus();
          });

        // Start the connection.
    $.connection.hub.start().done(function () {
          $('#btn_submit').click(function () {
            console.log("Suubmit");
                var msg = $("#chat_input").val();
                if (msg.length > 0) {
                    var userName = "@Session["Email"].ToString().Split('#')[0]";
                    objHub.server.sendMessageToGroup("@Model.ConnectionModelObj.GroupName", userName, msg);
                }
                // Clear text box and reset focus for next comment.
                $('#chat_input').val('').focus();
            });

            $("#btn_upload").click(function () {
                var userName = "@Session["Email"].ToString().Split('#')[0]";
                var formData = new FormData($("#form")[0]);
                formData.append('groupId','@Model.ConnectionModelObj.GroupName' );
                formData.append('userName',userName );

                $.ajax({
                    type: "POST",
                    cache: false,
                    data: formData,
                    url: '@Url.Action("UploadFileToChat")',
                    contentType: false,
                    processData: false,
                    success: function (success) {
                        objHub.server.sendMediaToGroup("@Model.ConnectionModelObj.GroupName", userName, success);
                        console.log(success);

                    },
                    error: function (result) {
                    }
                })
            });
        });

        $("body").on("contextmenu",".context-menu-one", function (e) {

            $("#dialog").attr("name", $(this).find("p").attr('id'));
            $("#dialog").toggle(100).css({
                top: e.pageY + "px",
                left: e.pageX + "px"
            });
            return false;
        });

        $('body').on("click", "div :not('.context-menu-one')", function (e) {
            $('#dialog').hide();
        });

        $("#dialog").on("click", function () {
            var msg_id = $(this).attr('name');
            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: '{"messageId":'+msg_id+'}',
                url: '@Url.Action("DeleteMessage")',
                success: function (success) {
                    console.log(success);
                    if (success == "Deleted") {
                        $("#" + msg_id).parent().hide();
                    }
                },
                error: function (result) {
                }
            })
        });

        function viewMediaMessage(link) {
            var url = window.location.href.split('/');
            var baseUrl = url[0] + '//' + url[2] + '//'+link.replace('~','').replaceAll('#','%23');
            var win = window.open(baseUrl, '_blank');
            win.focus();
        }
  </script>

}
