@using fyptest.Models
@model ChatRoom

@{ ViewBag.Title = "ConnectionList"; }

<div style="height: 113px;"></div>
<div class="unit-5 overlay" style="background-image: url('../../Image/Background/hero_1.jpg');">
  <div class="container text-center">
    <h2 class="mb-0">Chat</h2>
    <p class="mb-0 unit-6"><a href="index.html">Home</a> <span class="sep">></span> <span>Chat</span></p>
  </div>
</div>

<div class="site-section bg-light">
  <div class="container col-md-12 row">
    <div class="col-md-4">

      @foreach (var r in Model.chatList)
      {
        <a href="/Chat/ChatList?id=@r.ReceiverEmail" class="d-block d-md-flex align-items-center border-bottom">
          <div class="company-logo blank-logo text-center text-md-left pl-3">
            <img src="@r.ProfilePic" alt="Image" class="img-fluid mx-auto" style="height:50px;">
          </div>
          <div class="h-50 col-md-8">
            <div class="p-3 align-self-center">
              <h5>@r.ReceiverName</h5>
              <div class="d-block d-lg-flex">
                <div class="mr-3">
                  <span class="icon-suitcase mr-1"></span>
                  @r.ReceiverEmail
                </div>
              </div>
            </div>
          </div>
        </a>}
    </div>
    <div class="col-md-8" id="messages">
      @if (Model.message.ConnectionModelObj.GroupName == "00")
      {
      <div class="text-center ">
        <h4>No contact selected</h4>
      </div>
        
      }
      else
      {
        @Html.Partial("Contact", Model.message);
      }

    </div>
  </div>

</div>
<script src="~/Scripts/jquery.signalR-2.4.2.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/SignalR/Hubs/"></script>
@section foot {
  @Scripts.Render("~/bundles/jqueryval")
<script type="text/javascript">
        $(document).ready(function () {
            $("#chat-content").parent().height($(window).height());
            var height = $('#chat-content')[0].scrollHeight;
            $('#chat-content').scrollTop(height);

        });

        $("#uploadFile").on('click', function () {
            $("#modal").modal("show");
        });

        @*var objHub = $.connection.chatHub;
        $.connection.hub.start().done(function () {
              //loadEvents(objHub);
              objHub.server.connect("@Session["Email"].ToString()","@Session["Role"].ToString()");
              $('#chat_input').focus();
          });*@

        // Start the connection.
    $.connection.hub.start().done(function () {
          $('#btn_submit').click(function () {
            console.log("Suubmit");
                var msg = $("#chat_input").val();
                if (msg.length > 0) {
                  var userName = "@Session["Email"].ToString().Split('#')[0]";
                  var jobId = window.location.href.split('/')[3];
                    objHub.server.sendMessageToGroup("@Model.message.ConnectionModelObj.GroupName", userName, msg, jobId);
                }
                // Clear text box and reset focus for next comment.
                $('#chat_input').val('').focus();
            });

            $("#btn_upload").click(function () {
                var userName = "@Session["Email"].ToString().Split('#')[0]";
                var formData = new FormData($("#form")[0]);
                formData.append('groupId','@Model.message.ConnectionModelObj.GroupName' );
                formData.append('userName',userName );

                $.ajax({
                    type: "POST",
                    cache: false,
                    data: formData,
                    url: '@Url.Action("UploadFileToChat")',
                    contentType: false,
                    processData: false,
                    success: function (success) {
                        objHub.server.sendMediaToGroup("@Model.message.ConnectionModelObj.GroupName", userName, success);
                        console.log(success);

                    },
                    error: function (result) {
                    }
                })
            });
        });

        $("body").on("contextmenu",".context-menu-one", function (e) {

            $("#dialog").attr("name", $(this).find("p").attr('id'));
            $("#dialog").toggle(100).css({
                top: e.pageY + "px",
                left: e.pageX + "px"
            });
            return false;
        });

        $('body').on("click", "div :not('.context-menu-one')", function (e) {
            $('#dialog').hide();
        });

        $("#dialog").on("click", function () {
            var msg_id = $(this).attr('name');
            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                data: '{"messageId":'+msg_id+'}',
                url: '@Url.Action("DeleteMessage")',
                success: function (success) {
                    console.log(success);
                    if (success == "Deleted") {
                        $("#" + msg_id).parent().hide();
                    }
                },
                error: function (result) {
                }
            })
        });

        function viewMediaMessage(link) {
            var url = window.location.href.split('/');
            var baseUrl = url[0] + '//' + url[2] + '//'+link.replace('~','').replaceAll('#','%23');
            var win = window.open(baseUrl, '_blank');
            win.focus();
        }

    objHub.client.getMessages = function (userName, message, link, room) {
            @*if ('@Session["Email"]' != userName) {
                updateNotificationCount(link);
                $('#notiCon').append(link);
            }*@
      $("#chat_input").val('');
      $("#nochat").hide();
            var content = '';
            if ('@Session["Email"]'!= '') {
                if ('@Session["Email"]' != userName) {
                content = '<div class="media media-chat">' +
                    '<div class="media-body">' +
                    '<p>' + message + '</p >' +
                    '<p class="meta"><time datetime="2018">' + '@DateTime.Now.ToString("hh:mm")' + '</time></p>' +
                    '</div>' +
                    '</div>';
            }
            else {
                content =
                    '<div class="media media-chat media-chat-reverse">' +
                    '<div class="media-body">' +
                    '<p>' + message + '</p>' +
                    '<p class="meta"><time datetime="2018">' +'@DateTime.Now.ToString("hh:mm")'+'</time></p>' +
                        '</div>' +
                    '</div>';
                if ($("#chat-content .media-body").last().parent().hasClass("media-chat-reverse")) {

                    }

            }
            if ($("#" + room ).length > 0) {
                $('#chat-content').append(content);
                //updateNotificationCount();
            }
                var height = $('#chat-content')[0].scrollHeight;
                $('#chat-content').scrollTop(height);

            }
    }

</script>

}
